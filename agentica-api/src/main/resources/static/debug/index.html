<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentica Mission Control</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Outfit:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://unpkg.com/panzoom@9.4.3/dist/panzoom.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root {
            --bg-void: #06060a;
            --bg-primary: #0c0c14;
            --bg-secondary: #12121c;
            --bg-tertiary: #181824;
            --bg-elevated: #1e1e2c;
            --bg-surface: #242434;
            --border-subtle: #1a1a28;
            --border-default: #282840;
            --border-accent: #3a3a58;
            --border-glow: #4a4a6a;
            --text-primary: #f0f0f8;
            --text-secondary: #b0b0c8;
            --text-muted: #707090;
            --text-dim: #505068;
            --accent-cyan: #00e5ff;
            --accent-cyan-dim: rgba(0, 229, 255, 0.15);
            --accent-cyan-glow: rgba(0, 229, 255, 0.4);
            --accent-green: #00ff9d;
            --accent-green-dim: rgba(0, 255, 157, 0.15);
            --accent-amber: #ffb800;
            --accent-amber-dim: rgba(255, 184, 0, 0.15);
            --accent-red: #ff3d6e;
            --accent-red-dim: rgba(255, 61, 110, 0.15);
            --accent-purple: #b366ff;
            --accent-purple-dim: rgba(179, 102, 255, 0.15);
            --accent-blue: #4d9fff;
            --modal-backdrop: rgba(6, 6, 10, 0.92);
            --shadow-glow: 0 0 60px rgba(0, 229, 255, 0.08);
            --shadow-modal: 0 25px 80px rgba(0, 0, 0, 0.6), 0 0 1px rgba(255,255,255,0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-void);
            color: var(--text-primary);
            min-height: 100vh;
            font-size: 12px;
            line-height: 1.5;
            overflow: hidden;
        }

        /* Subtle grid background */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background:
                linear-gradient(90deg, var(--border-subtle) 1px, transparent 1px),
                linear-gradient(var(--border-subtle) 1px, transparent 1px);
            background-size: 60px 60px;
            opacity: 0.3;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            display: grid;
            grid-template-rows: 56px 1fr 52px;
            height: 100vh;
            position: relative;
            z-index: 1;
        }

        /* ═══════════════════════════════════════════════════════════════
           HEADER - Compact with Event Badge
           ═══════════════════════════════════════════════════════════════ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
            border-bottom: 1px solid var(--border-default);
            position: relative;
            z-index: 100;
        }

        .header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, var(--accent-cyan) 50%, transparent 100%);
            opacity: 0.4;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-mark {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-purple) 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Outfit', sans-serif;
            font-weight: 800;
            font-size: 18px;
            color: var(--bg-void);
            box-shadow: 0 0 20px var(--accent-cyan-glow);
        }

        .logo-text {
            font-family: 'Outfit', sans-serif;
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.5px;
            background: linear-gradient(135deg, var(--text-primary) 0%, var(--accent-cyan) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Event Badge - Clickable */
        .event-badge {
            display: none;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-default);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .event-badge.visible { display: flex; }

        .event-badge:hover {
            background: var(--bg-elevated);
            border-color: var(--accent-cyan);
            box-shadow: 0 0 20px var(--accent-cyan-dim);
        }

        .event-type-tag {
            padding: 4px 10px;
            background: var(--accent-cyan-dim);
            border: 1px solid var(--accent-cyan);
            border-radius: 4px;
            color: var(--accent-cyan);
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .event-source-text {
            font-size: 11px;
            color: var(--text-muted);
        }

        .event-expand-hint {
            font-size: 10px;
            color: var(--text-dim);
            margin-left: 8px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .status-pill {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-dim);
        }

        .status-dot.ready {
            background: var(--accent-green);
            box-shadow: 0 0 10px var(--accent-green);
        }

        .status-dot.active {
            background: var(--accent-purple);
            box-shadow: 0 0 10px var(--accent-purple);
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
        }

        .status-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .time-display {
            font-size: 11px;
            color: var(--text-muted);
            font-variant-numeric: tabular-nums;
        }

        /* ═══════════════════════════════════════════════════════════════
           MAIN LAYOUT - Graph Hero + Timeline Sidebar
           ═══════════════════════════════════════════════════════════════ */
        .main {
            display: grid;
            grid-template-columns: 1fr 360px;
            overflow: hidden;
        }

        /* Graph Panel - Full Width Hero */
        .graph-panel {
            position: relative;
            background: var(--bg-primary);
            overflow: hidden;
        }

        .graph-container {
            position: absolute;
            inset: 0;
            background:
                radial-gradient(ellipse at 30% 20%, rgba(0, 229, 255, 0.03) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 80%, rgba(179, 102, 255, 0.03) 0%, transparent 50%);
        }

        .graph-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 100%;
            min-height: 100%;
        }

        .graph-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 6px;
            z-index: 20;
        }

        .graph-btn {
            width: 36px;
            height: 36px;
            border: 1px solid var(--border-default);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.15s ease;
        }

        .graph-btn:hover {
            background: var(--bg-elevated);
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .zoom-badge {
            position: absolute;
            bottom: 20px;
            left: 20px;
            padding: 6px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            font-size: 10px;
            color: var(--text-dim);
        }

        .no-workflow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: var(--text-muted);
        }

        .no-workflow-icon {
            font-size: 64px;
            opacity: 0.15;
            margin-bottom: 16px;
            animation: float 4s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-12px); }
        }

        .no-workflow-text {
            font-family: 'Outfit', sans-serif;
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 6px;
        }

        .no-workflow-hint {
            font-size: 11px;
            color: var(--text-dim);
        }

        /* Timeline Sidebar */
        .timeline-panel {
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-default);
            overflow: hidden;
            min-height: 0;  /* Allow flex child to shrink and enable scrolling */
        }

        .panel-header {
            padding: 14px 16px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-default);
        }

        .panel-title {
            font-family: 'Outfit', sans-serif;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-muted);
        }

        .timeline-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            min-height: 0;  /* Enable scrolling in flex container */
        }

        .timeline-scroll::-webkit-scrollbar { width: 6px; }
        .timeline-scroll::-webkit-scrollbar-track { background: transparent; }
        .timeline-scroll::-webkit-scrollbar-thumb { background: var(--border-accent); border-radius: 3px; }

        .timeline-section {
            margin-bottom: 20px;
        }

        .timeline-section-label {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-dim);
            margin-bottom: 10px;
            padding-left: 4px;
        }

        /* Timeline Items */
        .timeline-item {
            position: relative;
            padding: 12px 14px;
            margin-bottom: 8px;
            background: var(--bg-primary);
            border-radius: 8px;
            border: 1px solid var(--border-subtle);
            border-left: 3px solid var(--text-dim);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .timeline-item:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-default);
        }

        .timeline-item.completed { border-left-color: var(--accent-green); }
        .timeline-item.running {
            border-left-color: var(--accent-purple);
            animation: item-pulse 2s ease-in-out infinite;
        }
        .timeline-item.escalated { border-left-color: var(--accent-amber); }
        .timeline-item.failed { border-left-color: var(--accent-red); }

        @keyframes item-pulse {
            0%, 100% { background: var(--bg-primary); }
            50% { background: var(--bg-tertiary); }
        }

        .timeline-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .timeline-node-name {
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            font-size: 12px;
            color: var(--text-primary);
        }

        .timeline-agent-tag {
            font-size: 9px;
            padding: 2px 6px;
            background: var(--bg-surface);
            border-radius: 3px;
            color: var(--accent-cyan);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .timeline-item-meta {
            display: flex;
            gap: 12px;
            font-size: 10px;
            color: var(--text-dim);
        }

        .timeline-escalation-badge {
            margin-top: 8px;
            padding: 6px 10px;
            background: var(--accent-amber-dim);
            border-radius: 4px;
            font-size: 10px;
            color: var(--accent-amber);
        }

        /* Replan Items */
        .replan-item {
            position: relative;
            padding: 12px 14px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--accent-amber-dim) 0%, transparent 100%);
            border-radius: 8px;
            border: 1px solid rgba(255, 184, 0, 0.25);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .replan-item:hover {
            background: linear-gradient(135deg, rgba(255, 184, 0, 0.12) 0%, transparent 100%);
            border-color: rgba(255, 184, 0, 0.4);
        }

        .replan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .replan-tag {
            font-size: 9px;
            padding: 2px 6px;
            background: var(--accent-amber);
            border-radius: 3px;
            color: var(--bg-void);
            font-weight: 700;
            text-transform: uppercase;
        }

        .replan-action {
            font-size: 10px;
            color: var(--accent-amber);
        }

        .replan-trigger {
            font-size: 10px;
            color: var(--text-muted);
        }

        .replan-trigger strong {
            color: var(--accent-red);
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            color: var(--text-dim);
            text-align: center;
        }

        .empty-state-icon {
            font-size: 28px;
            opacity: 0.3;
            margin-bottom: 10px;
        }

        /* ═══════════════════════════════════════════════════════════════
           FOOTER - Execution Info + History
           ═══════════════════════════════════════════════════════════════ */
        .footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-default);
        }

        .exec-info {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .exec-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .exec-label {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-dim);
        }

        .exec-value {
            font-size: 11px;
            color: var(--text-secondary);
        }

        .exec-value.running { color: var(--accent-purple); }
        .exec-value.completed { color: var(--accent-green); }
        .exec-value.failed { color: var(--accent-red); }
        .exec-value.aborted { color: var(--accent-amber); }

        .history-nav {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .history-btn {
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-muted);
            font-size: 10px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .history-btn:hover {
            background: var(--bg-elevated);
            border-color: var(--border-default);
            color: var(--text-secondary);
        }

        .history-btn.active {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }

        .back-to-live {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--accent-cyan);
            border-radius: 6px;
            color: var(--accent-cyan);
            font-size: 10px;
            cursor: pointer;
            transition: all 0.15s ease;
            display: none;
        }

        .back-to-live.visible { display: block; }

        .back-to-live:hover {
            background: var(--accent-cyan-dim);
        }

        /* ═══════════════════════════════════════════════════════════════
           MODAL SYSTEM
           ═══════════════════════════════════════════════════════════════ */
        .modal-backdrop {
            position: fixed;
            inset: 0;
            background: var(--modal-backdrop);
            backdrop-filter: blur(8px);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s ease;
        }

        .modal-backdrop.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            width: 90%;
            max-width: 800px;
            max-height: 85vh;
            background: var(--bg-secondary);
            border: 1px solid var(--border-default);
            border-radius: 16px;
            box-shadow: var(--shadow-modal);
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.25s ease;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal.visible {
            opacity: 1;
            visibility: visible;
            transform: translate(-50%, -50%) scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 24px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-default);
        }

        .modal-title {
            font-family: 'Outfit', sans-serif;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-title-icon {
            width: 32px;
            height: 32px;
            background: var(--accent-cyan-dim);
            border: 1px solid var(--accent-cyan);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            background: transparent;
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 18px;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: var(--bg-elevated);
            border-color: var(--border-default);
            color: var(--text-primary);
        }

        .modal-tabs {
            display: flex;
            gap: 2px;
            padding: 12px 24px 0;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-default);
        }

        .modal-tab {
            padding: 10px 18px;
            background: transparent;
            border: none;
            border-bottom: 2px solid transparent;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.15s ease;
            margin-bottom: -1px;
        }

        .modal-tab:hover {
            color: var(--text-secondary);
        }

        .modal-tab.active {
            color: var(--accent-cyan);
            border-bottom-color: var(--accent-cyan);
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        .modal-body::-webkit-scrollbar { width: 8px; }
        .modal-body::-webkit-scrollbar-track { background: var(--bg-tertiary); }
        .modal-body::-webkit-scrollbar-thumb { background: var(--border-accent); border-radius: 4px; }

        /* Modal Content Sections */
        .modal-section {
            margin-bottom: 28px;
        }

        .modal-section:last-child {
            margin-bottom: 0;
        }

        .modal-section-title {
            font-family: 'Outfit', sans-serif;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-dim);
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border-subtle);
        }

        .info-grid {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 10px 16px;
        }

        .info-label {
            font-size: 11px;
            color: var(--text-dim);
        }

        .info-value {
            font-size: 11px;
            color: var(--text-primary);
            word-break: break-word;
        }

        .info-value.cyan { color: var(--accent-cyan); }
        .info-value.green { color: var(--accent-green); }
        .info-value.amber { color: var(--accent-amber); }
        .info-value.red { color: var(--accent-red); }
        .info-value.purple { color: var(--accent-purple); }

        /* Plan Comparison */
        .plan-comparison {
            display: flex;
            gap: 16px;
            align-items: flex-start;
        }

        .plan-side {
            flex: 1;
            background: var(--bg-void);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            overflow: hidden;
        }

        .plan-header {
            padding: 10px 14px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .plan-header.previous {
            background: var(--accent-red-dim);
            color: var(--accent-red);
        }

        .plan-header.new {
            background: var(--accent-green-dim);
            color: var(--accent-green);
        }

        .plan-arrow {
            font-size: 24px;
            color: var(--text-dim);
            padding-top: 40px;
        }

        .plan-summary {
            padding: 14px;
        }

        .plan-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .plan-entry {
            font-size: 11px;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .plan-entry .cyan { color: var(--accent-cyan); }

        .plan-nodes-title, .plan-edges-title {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-dim);
            margin: 12px 0 6px;
        }

        .plan-nodes-list, .plan-edges-list {
            font-size: 11px;
        }

        .plan-node-item, .plan-edge-item {
            padding: 4px 0;
            color: var(--text-secondary);
        }

        .plan-node-item .node-id {
            color: var(--accent-cyan);
        }

        .plan-node-item .node-type {
            color: var(--text-dim);
            margin-left: 8px;
            font-size: 10px;
        }

        .plan-empty {
            padding: 20px;
            text-align: center;
            color: var(--text-dim);
            font-size: 11px;
        }

        /* Collapsible Sections */
        .modal-section-title.collapsible {
            cursor: pointer;
            user-select: none;
        }

        .modal-section-title.collapsible:hover {
            color: var(--accent-cyan);
        }

        .modal-section-title .toggle-icon {
            font-size: 10px;
            margin-left: auto;
            margin-right: 12px;
            color: var(--text-dim);
        }

        .collapsible-content {
            margin-top: -8px;
        }

        /* Code/JSON Viewer */
        .code-viewer {
            background: var(--bg-void);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            overflow: hidden;
        }

        .code-viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-subtle);
        }

        .code-viewer-label {
            font-size: 10px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .code-viewer-copy {
            padding: 4px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .code-viewer-copy:hover {
            background: var(--bg-elevated);
            color: var(--text-secondary);
        }

        .code-viewer-content {
            padding: 16px;
            max-height: 300px;
            overflow: auto;
            font-size: 11px;
            line-height: 1.6;
        }

        .code-viewer-content::-webkit-scrollbar { width: 6px; height: 6px; }
        .code-viewer-content::-webkit-scrollbar-track { background: transparent; }
        .code-viewer-content::-webkit-scrollbar-thumb { background: var(--border-accent); border-radius: 3px; }

        .code-viewer-content pre {
            margin: 0;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .code-viewer-content code {
            font-family: 'JetBrains Mono', monospace;
            background: transparent !important;
            padding: 0 !important;
        }

        /* Markdown Viewer */
        .md-viewer {
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 20px;
            font-size: 12px;
            line-height: 1.7;
            color: var(--text-secondary);
        }

        .md-viewer h1, .md-viewer h2, .md-viewer h3 {
            font-family: 'Outfit', sans-serif;
            color: var(--text-primary);
            margin: 16px 0 8px;
        }

        .md-viewer h1 { font-size: 18px; }
        .md-viewer h2 { font-size: 15px; }
        .md-viewer h3 { font-size: 13px; }

        .md-viewer p { margin: 10px 0; }

        .md-viewer code {
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
        }

        .md-viewer pre {
            background: var(--bg-void);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 14px;
            overflow-x: auto;
            margin: 12px 0;
        }

        .md-viewer pre code {
            background: transparent;
            padding: 0;
        }

        .md-viewer ul, .md-viewer ol {
            margin: 10px 0;
            padding-left: 24px;
        }

        .md-viewer li { margin: 4px 0; }

        /* Payload Grid */
        .payload-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .payload-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 14px;
        }

        .payload-key {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-dim);
            margin-bottom: 6px;
        }

        .payload-value {
            font-size: 12px;
            color: var(--text-primary);
            word-break: break-word;
        }

        /* LLM Message Cards */
        .llm-message {
            margin-bottom: 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            overflow: hidden;
        }

        .llm-message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-subtle);
        }

        .llm-role {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .llm-role.system { color: var(--accent-cyan); }
        .llm-role.user { color: var(--accent-green); }
        .llm-role.assistant { color: var(--accent-purple); }

        .llm-message-body {
            padding: 14px;
            font-size: 12px;
            line-height: 1.6;
            color: var(--text-secondary);
            max-height: 200px;
            overflow-y: auto;
        }

        /* Tool Call Cards */
        .tool-call-card {
            margin-bottom: 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            border-left: 3px solid var(--accent-amber);
            overflow: hidden;
        }

        .tool-call-card.success { border-left-color: var(--accent-green); }
        .tool-call-card.error { border-left-color: var(--accent-red); }

        .tool-call-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 14px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-subtle);
        }

        .tool-name {
            font-weight: 600;
            color: var(--accent-cyan);
            font-size: 12px;
        }

        .tool-duration {
            font-size: 10px;
            color: var(--text-dim);
        }

        .tool-call-body {
            padding: 14px;
        }

        .tool-section {
            margin-bottom: 12px;
        }

        .tool-section:last-child { margin-bottom: 0; }

        .tool-section-label {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-dim);
            margin-bottom: 6px;
        }

        .tool-section-content {
            background: var(--bg-void);
            border-radius: 6px;
            padding: 10px;
            font-size: 11px;
            max-height: 120px;
            overflow: auto;
        }

        .tool-error {
            color: var(--accent-red);
            padding: 10px;
            background: var(--accent-red-dim);
            border-radius: 6px;
            font-size: 11px;
        }

        /* Token Stats */
        .token-stats {
            display: flex;
            gap: 16px;
        }

        .token-stat {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg-primary);
            border-radius: 6px;
            font-size: 11px;
        }

        .token-stat-label {
            color: var(--text-dim);
        }

        .token-stat-value {
            font-weight: 600;
        }

        .token-stat-value.input { color: var(--accent-green); }
        .token-stat-value.output { color: var(--accent-purple); }

        /* History Modal */
        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }

        .history-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .history-card:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-default);
        }

        .history-card.selected {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 20px var(--accent-cyan-dim);
        }

        .history-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .history-card-title {
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            font-size: 13px;
            color: var(--text-primary);
        }

        .history-status-badge {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 9px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .history-status-badge.COMPLETED { background: var(--accent-green-dim); color: var(--accent-green); }
        .history-status-badge.FAILED { background: var(--accent-red-dim); color: var(--accent-red); }
        .history-status-badge.ABORTED { background: var(--accent-amber-dim); color: var(--accent-amber); }
        .history-status-badge.RUNNING { background: var(--accent-purple-dim); color: var(--accent-purple); }

        .history-card-meta {
            display: flex;
            gap: 16px;
            font-size: 10px;
            color: var(--text-muted);
        }

        /* Mermaid Overrides */
        .mermaid { background: transparent !important; }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="logo">
                    <div class="logo-mark">A</div>
                    <span class="logo-text">Agentica</span>
                </div>

                <!-- Compact Event Badge -->
                <div id="event-badge" class="event-badge" onclick="openEventModal()">
                    <span id="event-type-tag" class="event-type-tag">-</span>
                    <span id="event-source-text" class="event-source-text">-</span>
                    <span class="event-expand-hint">Click for details</span>
                </div>
            </div>

            <div class="header-right">
                <div class="status-pill">
                    <div id="status-dot" class="status-dot"></div>
                    <span id="status-label" class="status-label">Initializing</span>
                </div>
                <span id="time-display" class="time-display">--:--:--</span>
            </div>
        </header>

        <!-- Main -->
        <main class="main">
            <!-- Graph Panel -->
            <div class="graph-panel">
                <div id="graph-container" class="graph-container">
                    <div id="graph-wrapper" class="graph-wrapper">
                        <div id="mermaid-container"></div>
                    </div>
                    <div id="no-workflow" class="no-workflow">
                        <div class="no-workflow-icon">&#9673;</div>
                        <div class="no-workflow-text">Awaiting Workflow</div>
                        <div class="no-workflow-hint">Send an event to begin orchestration</div>
                    </div>
                    <div class="graph-controls">
                        <button class="graph-btn" onclick="zoomIn()" title="Zoom In">+</button>
                        <button class="graph-btn" onclick="zoomOut()" title="Zoom Out">−</button>
                        <button class="graph-btn" onclick="resetZoom()" title="Reset">⟲</button>
                    </div>
                    <div id="zoom-badge" class="zoom-badge">100%</div>
                </div>
            </div>

            <!-- Timeline Panel -->
            <div class="timeline-panel">
                <div class="panel-header">
                    <span class="panel-title">Execution Timeline</span>
                </div>
                <div id="timeline-scroll" class="timeline-scroll">
                    <div class="empty-state">
                        <div class="empty-state-icon">&#8987;</div>
                        <div>No activity yet</div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="exec-info">
                <div class="exec-item">
                    <span class="exec-label">Event</span>
                    <span id="exec-event-id" class="exec-value">-</span>
                </div>
                <div class="exec-item">
                    <span class="exec-label">Workflow</span>
                    <span id="exec-workflow" class="exec-value">-</span>
                </div>
                <div class="exec-item">
                    <span class="exec-label">Status</span>
                    <span id="exec-status" class="exec-value">-</span>
                </div>
                <div class="exec-item">
                    <span class="exec-label">Duration</span>
                    <span id="exec-duration" class="exec-value">-</span>
                </div>
                <div class="exec-item">
                    <span class="exec-label">Replans</span>
                    <span id="exec-replans" class="exec-value">0</span>
                </div>
            </div>
            <div class="history-nav">
                <button class="history-btn" onclick="openHistoryModal()">View History</button>
                <button id="back-to-live" class="back-to-live" onclick="backToLive()">← Back to Live</button>
            </div>
        </footer>
    </div>

    <!-- Modal Backdrop -->
    <div id="modal-backdrop" class="modal-backdrop" onclick="closeModal()"></div>

    <!-- Event Details Modal -->
    <div id="event-modal" class="modal">
        <div class="modal-header">
            <div class="modal-title">
                <div class="modal-title-icon">&#9889;</div>
                <span>Event Details</span>
            </div>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="event-modal-content"></div>
        </div>
    </div>

    <!-- Node Details Modal -->
    <div id="node-modal" class="modal">
        <div class="modal-header">
            <div class="modal-title">
                <div class="modal-title-icon">&#9881;</div>
                <span id="node-modal-title">Node Details</span>
            </div>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-tabs" id="node-modal-tabs">
            <button class="modal-tab active" data-tab="overview" onclick="switchTab('node', 'overview')">Overview</button>
            <button class="modal-tab" data-tab="llm" onclick="switchTab('node', 'llm')">LLM</button>
            <button class="modal-tab" data-tab="tools" onclick="switchTab('node', 'tools')">Tools</button>
            <button class="modal-tab" data-tab="output" onclick="switchTab('node', 'output')">Output</button>
        </div>
        <div class="modal-body">
            <div id="node-tab-overview" class="tab-content active"></div>
            <div id="node-tab-llm" class="tab-content"></div>
            <div id="node-tab-tools" class="tab-content"></div>
            <div id="node-tab-output" class="tab-content"></div>
        </div>
    </div>

    <!-- Replan Details Modal -->
    <div id="replan-modal" class="modal">
        <div class="modal-header">
            <div class="modal-title">
                <div class="modal-title-icon" style="background: var(--accent-amber-dim); border-color: var(--accent-amber);">&#8635;</div>
                <span id="replan-modal-title">Replan Details</span>
            </div>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="replan-modal-content"></div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="history-modal" class="modal" style="max-width: 900px;">
        <div class="modal-header">
            <div class="modal-title">
                <div class="modal-title-icon">&#128203;</div>
                <span>Execution History</span>
            </div>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="history-modal-content"></div>
        </div>
    </div>

    <script>
        // Initialize Mermaid
        mermaid.initialize({
            startOnLoad: false,
            theme: 'dark',
            themeVariables: {
                primaryColor: '#1e1e2c',
                primaryTextColor: '#f0f0f8',
                primaryBorderColor: '#282840',
                lineColor: '#3a3a58',
                secondaryColor: '#12121c',
                tertiaryColor: '#0c0c14',
                background: 'transparent',
                mainBkg: '#1e1e2c',
                nodeBorder: '#282840'
            },
            flowchart: {
                curve: 'basis',
                padding: 20,
                nodeSpacing: 50,
                rankSpacing: 70
            }
        });

        // State
        let currentState = null;
        let selectedEventId = null;
        let panzoomInstance = null;
        let activeModal = null;
        let currentViewedEventId = null;  // Track which execution is currently displayed
        let savedTransform = null;        // Save pan/zoom position between renders

        // ═══════════════════════════════════════════════════════════════
        // UTILITY FUNCTIONS
        // ═══════════════════════════════════════════════════════════════

        function formatDuration(ms) {
            if (!ms || ms === 0) return '-';
            if (ms < 1000) return `${ms}ms`;
            if (ms < 60000) return `${(ms / 1000).toFixed(1)}s`;
            return `${(ms / 60000).toFixed(1)}m`;
        }

        function formatTime(timestamp) {
            if (!timestamp) return '-';
            return new Date(timestamp).toLocaleTimeString();
        }

        function truncate(text, maxLen) {
            if (!text) return '';
            if (text.length <= maxLen) return text;
            return text.substring(0, maxLen) + '...';
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function copyToClipboard(text, btn) {
            navigator.clipboard.writeText(text).then(() => {
                const original = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = original, 1500);
            });
        }

        function updateTime() {
            document.getElementById('time-display').textContent = new Date().toLocaleTimeString();
        }
        setInterval(updateTime, 1000);
        updateTime();

        // ═══════════════════════════════════════════════════════════════
        // PANZOOM
        // ═══════════════════════════════════════════════════════════════

        function initPanzoom(restorePosition = false) {
            const wrapper = document.getElementById('graph-wrapper');

            if (panzoomInstance) {
                panzoomInstance.dispose();
                panzoomInstance = null;
            }

            // Reset transform before initializing
            wrapper.style.transform = '';

            panzoomInstance = panzoom(wrapper, {
                maxZoom: 5,
                minZoom: 0.2,
                initialZoom: 1,
                bounds: false,
                smoothScroll: false
            });

            panzoomInstance.on('zoom', (e) => {
                document.getElementById('zoom-badge').textContent = Math.round(e.getTransform().scale * 100) + '%';
            });

            // Restore previous position or center the graph
            if (restorePosition && savedTransform) {
                // Restore saved pan/zoom position
                panzoomInstance.zoomAbs(savedTransform.x, savedTransform.y, savedTransform.scale);
                document.getElementById('zoom-badge').textContent = Math.round(savedTransform.scale * 100) + '%';
            } else {
                // Center the graph in the viewport (new execution)
                centerGraph();
                document.getElementById('zoom-badge').textContent = '100%';
            }
        }

        function centerGraph() {
            // Use requestAnimationFrame to ensure SVG is fully rendered
            requestAnimationFrame(() => {
                if (!panzoomInstance) return;

                const wrapper = document.getElementById('graph-wrapper');
                const container = document.getElementById('graph-container');
                const svg = wrapper.querySelector('svg');

                if (!svg) return;

                const containerRect = container.getBoundingClientRect();
                const svgRect = svg.getBoundingClientRect();

                // Calculate center position
                const x = (containerRect.width - svgRect.width) / 2;
                const y = (containerRect.height - svgRect.height) / 2;

                // Move to center position
                panzoomInstance.moveTo(x, y);
            });
        }

        function zoomIn() {
            if (panzoomInstance) {
                const t = panzoomInstance.getTransform();
                panzoomInstance.zoomTo(t.x, t.y, t.scale * 1.25);
            }
        }

        function zoomOut() {
            if (panzoomInstance) {
                const t = panzoomInstance.getTransform();
                panzoomInstance.zoomTo(t.x, t.y, t.scale * 0.8);
            }
        }

        function resetZoom() {
            // Clear saved transform so we re-center
            savedTransform = null;

            if (panzoomInstance) {
                panzoomInstance.dispose();
                panzoomInstance = null;
            }

            const wrapper = document.getElementById('graph-wrapper');
            wrapper.style.transform = '';
            initPanzoom(false);  // false = center the graph
        }

        // ═══════════════════════════════════════════════════════════════
        // MODAL SYSTEM
        // ═══════════════════════════════════════════════════════════════

        function openModal(modalId) {
            closeModal();
            document.getElementById('modal-backdrop').classList.add('visible');
            document.getElementById(modalId).classList.add('visible');
            activeModal = modalId;
        }

        function closeModal() {
            document.getElementById('modal-backdrop').classList.remove('visible');
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('visible'));
            activeModal = null;
        }

        function switchTab(modalType, tabName) {
            const tabs = document.querySelectorAll(`#${modalType}-modal-tabs .modal-tab`);
            tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === tabName));

            const prefix = modalType === 'node' ? 'node-tab-' : '';
            document.querySelectorAll(`[id^="${prefix}"]`).forEach(c => {
                if (c.classList.contains('tab-content')) {
                    c.classList.toggle('active', c.id === `${prefix}${tabName}`);
                }
            });
        }

        // ═══════════════════════════════════════════════════════════════
        // EVENT MODAL
        // ═══════════════════════════════════════════════════════════════

        function openEventModal() {
            if (!currentState?.triggerEvent) return;

            const event = currentState.triggerEvent;
            let html = `
                <div class="modal-section">
                    <div class="modal-section-title">Event Information</div>
                    <div class="info-grid">
                        <span class="info-label">Event ID</span>
                        <span class="info-value">${escapeHtml(event.id || '-')}</span>
                        <span class="info-label">Type</span>
                        <span class="info-value cyan">${escapeHtml(event.eventType || '-')}</span>
                        <span class="info-label">Source</span>
                        <span class="info-value">${escapeHtml(event.source || '-')}</span>
                        <span class="info-label">Received</span>
                        <span class="info-value">${formatTime(event.receivedAt)}</span>
                    </div>
                </div>
            `;

            if (event.payload && Object.keys(event.payload).length > 0) {
                html += `
                    <div class="modal-section">
                        <div class="modal-section-title">Payload</div>
                        <div class="payload-grid">
                `;

                for (const [key, value] of Object.entries(event.payload)) {
                    const displayValue = typeof value === 'object' ? JSON.stringify(value) : String(value);
                    html += `
                        <div class="payload-card">
                            <div class="payload-key">${escapeHtml(key)}</div>
                            <div class="payload-value">${escapeHtml(truncate(displayValue, 100))}</div>
                        </div>
                    `;
                }

                html += '</div></div>';

                // Full JSON view
                const jsonStr = JSON.stringify(event.payload, null, 2);
                html += `
                    <div class="modal-section">
                        <div class="modal-section-title">Raw JSON</div>
                        <div class="code-viewer">
                            <div class="code-viewer-header">
                                <span class="code-viewer-label">application/json</span>
                                <button class="code-viewer-copy" onclick="copyToClipboard(${JSON.stringify(jsonStr)}, this)">Copy</button>
                            </div>
                            <div class="code-viewer-content">
                                <pre><code class="language-json">${escapeHtml(jsonStr)}</code></pre>
                            </div>
                        </div>
                    </div>
                `;
            }

            document.getElementById('event-modal-content').innerHTML = html;
            hljs.highlightAll();
            openModal('event-modal');
        }

        // ═══════════════════════════════════════════════════════════════
        // NODE MODAL
        // ═══════════════════════════════════════════════════════════════

        function openNodeModal(nodeId) {
            const node = currentState?.timeline?.find(n => n.nodeId === nodeId);
            if (!node) return;

            document.getElementById('node-modal-title').textContent = `Node: ${node.nodeId}`;

            // Overview Tab
            let overviewHtml = `
                <div class="modal-section">
                    <div class="modal-section-title">Node Information</div>
                    <div class="info-grid">
                        <span class="info-label">Node ID</span>
                        <span class="info-value">${escapeHtml(node.nodeId)}</span>
                        <span class="info-label">Agent Type</span>
                        <span class="info-value cyan">${node.agentType || '-'}</span>
                        <span class="info-label">Status</span>
                        <span class="info-value ${(node.status || '').toLowerCase()}">${node.status || '-'}</span>
                        <span class="info-label">Started</span>
                        <span class="info-value">${formatTime(node.startedAt)}</span>
                        <span class="info-label">Duration</span>
                        <span class="info-value">${formatDuration(node.durationMs)}</span>
                    </div>
                </div>
            `;

            if (node.escalationReason) {
                overviewHtml += `
                    <div class="modal-section">
                        <div class="modal-section-title">Escalation</div>
                        <div class="info-grid">
                            <span class="info-label">Reason</span>
                            <span class="info-value amber">${escapeHtml(node.escalationReason)}</span>
                        </div>
                        ${node.escalationContext ? `
                            <div style="margin-top: 12px;">
                                <div class="code-viewer">
                                    <div class="code-viewer-header">
                                        <span class="code-viewer-label">Error Context</span>
                                    </div>
                                    <div class="code-viewer-content">
                                        <pre style="color: var(--accent-red);">${escapeHtml(node.escalationContext)}</pre>
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            document.getElementById('node-tab-overview').innerHTML = overviewHtml;

            // LLM Tab
            let llmHtml = '';
            if (node.agentExecutions && node.agentExecutions.length > 0) {
                for (const exec of node.agentExecutions) {
                    if (exec.llmInteraction) {
                        const llm = exec.llmInteraction;
                        llmHtml += `
                            <div class="modal-section">
                                <div class="modal-section-title">${exec.phase || 'LLM Interaction'}</div>
                                <div class="info-grid" style="margin-bottom: 16px;">
                                    <span class="info-label">Model</span>
                                    <span class="info-value">${escapeHtml(llm.model || '-')}</span>
                                    <span class="info-label">Latency</span>
                                    <span class="info-value">${formatDuration(llm.latencyMs)}</span>
                                </div>
                                <div class="token-stats" style="margin-bottom: 16px;">
                                    <div class="token-stat">
                                        <span class="token-stat-label">Input:</span>
                                        <span class="token-stat-value input">${llm.inputTokens || 0}</span>
                                    </div>
                                    <div class="token-stat">
                                        <span class="token-stat-label">Output:</span>
                                        <span class="token-stat-value output">${llm.outputTokens || 0}</span>
                                    </div>
                                </div>
                        `;

                        if (llm.systemPrompt) {
                            llmHtml += `
                                <div style="margin-bottom: 16px;">
                                    <div class="llm-message">
                                        <div class="llm-message-header">
                                            <span class="llm-role system">System Prompt</span>
                                        </div>
                                        <div class="llm-message-body">${escapeHtml(llm.systemPrompt)}</div>
                                    </div>
                                </div>
                            `;
                        }

                        if (llm.messages && llm.messages.length > 0) {
                            for (const msg of llm.messages) {
                                llmHtml += `
                                    <div class="llm-message">
                                        <div class="llm-message-header">
                                            <span class="llm-role ${msg.role || 'unknown'}">${msg.role || 'unknown'}</span>
                                        </div>
                                        <div class="llm-message-body">${escapeHtml(msg.content || '')}</div>
                                    </div>
                                `;
                            }
                        }

                        if (llm.rawResponse) {
                            const rawResp = llm.rawResponse;
                            llmHtml += `
                                <div class="code-viewer" style="margin-top: 16px;">
                                    <div class="code-viewer-header">
                                        <span class="code-viewer-label">Raw Response</span>
                                        <button class="code-viewer-copy" onclick="copyToClipboard(${JSON.stringify(rawResp)}, this)">Copy</button>
                                    </div>
                                    <div class="code-viewer-content">
                                        <pre>${escapeHtml(rawResp)}</pre>
                                    </div>
                                </div>
                            `;
                        }

                        llmHtml += '</div>';
                    }
                }
            }

            document.getElementById('node-tab-llm').innerHTML = llmHtml || '<div class="empty-state"><div class="empty-state-icon">&#128172;</div><div>No LLM interactions</div></div>';

            // Tools Tab
            let toolsHtml = '';
            if (node.agentExecutions && node.agentExecutions.length > 0) {
                for (const exec of node.agentExecutions) {
                    if (exec.toolCalls && exec.toolCalls.length > 0) {
                        for (const tc of exec.toolCalls) {
                            const tcClass = tc.success ? 'success' : (tc.error ? 'error' : '');
                            toolsHtml += `
                                <div class="tool-call-card ${tcClass}">
                                    <div class="tool-call-header">
                                        <span class="tool-name">${escapeHtml(tc.toolName || 'unknown')}</span>
                                        <span class="tool-duration">${formatDuration(tc.durationMs)}</span>
                                    </div>
                                    <div class="tool-call-body">
                            `;

                            if (tc.toolInput) {
                                toolsHtml += `
                                    <div class="tool-section">
                                        <div class="tool-section-label">Input</div>
                                        <div class="tool-section-content"><pre>${escapeHtml(tc.toolInput)}</pre></div>
                                    </div>
                                `;
                            }

                            if (tc.toolOutput) {
                                toolsHtml += `
                                    <div class="tool-section">
                                        <div class="tool-section-label">Output</div>
                                        <div class="tool-section-content"><pre>${escapeHtml(tc.toolOutput)}</pre></div>
                                    </div>
                                `;
                            }

                            if (tc.error) {
                                toolsHtml += `<div class="tool-error">${escapeHtml(tc.error)}</div>`;
                            }

                            toolsHtml += '</div></div>';
                        }
                    }
                }
            }

            document.getElementById('node-tab-tools').innerHTML = toolsHtml || '<div class="empty-state"><div class="empty-state-icon">&#128295;</div><div>No tool calls</div></div>';

            // Output Tab
            let outputHtml = '';
            if (node.output) {
                const outputStr = typeof node.output === 'object' ? JSON.stringify(node.output, null, 2) : String(node.output);
                const isJson = typeof node.output === 'object';

                outputHtml = `
                    <div class="modal-section">
                        <div class="modal-section-title">Node Output</div>
                        <div class="code-viewer">
                            <div class="code-viewer-header">
                                <span class="code-viewer-label">${isJson ? 'application/json' : 'text/plain'}</span>
                                <button class="code-viewer-copy" onclick="copyToClipboard(${JSON.stringify(outputStr)}, this)">Copy</button>
                            </div>
                            <div class="code-viewer-content">
                                <pre><code class="${isJson ? 'language-json' : ''}">${escapeHtml(outputStr)}</code></pre>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                outputHtml = '<div class="empty-state"><div class="empty-state-icon">&#128196;</div><div>No output data</div></div>';
            }

            document.getElementById('node-tab-output').innerHTML = outputHtml;

            // Reset to overview tab
            switchTab('node', 'overview');
            hljs.highlightAll();
            openModal('node-modal');
        }

        // ═══════════════════════════════════════════════════════════════
        // REPLAN MODAL
        // ═══════════════════════════════════════════════════════════════

        function openReplanModal(idx) {
            const replan = currentState?.replans?.[idx];
            if (!replan) return;

            document.getElementById('replan-modal-title').textContent = `Replan #${replan.replanNumber}`;

            let html = `
                <div class="modal-section">
                    <div class="modal-section-title">Replan Information</div>
                    <div class="info-grid">
                        <span class="info-label">Replan #</span>
                        <span class="info-value">${replan.replanNumber}</span>
                        <span class="info-label">Action</span>
                        <span class="info-value amber">${replan.action || '-'}</span>
                        <span class="info-label">Trigger Node</span>
                        <span class="info-value red">${escapeHtml(replan.triggerNodeId || '-')}</span>
                        <span class="info-label">Resume From</span>
                        <span class="info-value">${escapeHtml(replan.resumeFrom || '-')}</span>
                        <span class="info-label">Time</span>
                        <span class="info-value">${formatTime(replan.timestamp)}</span>
                    </div>
                </div>

                <div class="modal-section">
                    <div class="modal-section-title">Escalation Reason</div>
                    <div class="code-viewer">
                        <div class="code-viewer-content">
                            <pre>${escapeHtml(replan.escalationReason || 'No reason provided')}</pre>
                        </div>
                    </div>
                </div>
            `;

            if (replan.escalationContext) {
                html += `
                    <div class="modal-section">
                        <div class="modal-section-title">Error Context</div>
                        <div class="code-viewer">
                            <div class="code-viewer-content">
                                <pre style="color: var(--accent-red);">${escapeHtml(replan.escalationContext)}</pre>
                            </div>
                        </div>
                    </div>
                `;
            }

            if (replan.guidance) {
                // Try to render as markdown
                let guidanceHtml;
                try {
                    guidanceHtml = marked.parse(replan.guidance);
                } catch {
                    guidanceHtml = `<pre>${escapeHtml(replan.guidance)}</pre>`;
                }

                html += `
                    <div class="modal-section">
                        <div class="modal-section-title">Orchestrator Guidance</div>
                        <div class="md-viewer">${guidanceHtml}</div>
                    </div>
                `;
            }

            if (replan.abortReason) {
                html += `
                    <div class="modal-section">
                        <div class="modal-section-title">Abort Reason</div>
                        <div class="code-viewer">
                            <div class="code-viewer-content">
                                <pre style="color: var(--accent-red);">${escapeHtml(replan.abortReason)}</pre>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Workflow Plan Comparison
            if (replan.previousPlan || replan.newPlan) {
                html += `
                    <div class="modal-section">
                        <div class="modal-section-title">Workflow Plan Comparison</div>
                        <div class="plan-comparison">
                            <div class="plan-side">
                                <div class="plan-header previous">Previous Plan (v${replan.previousPlan?.version || '?'})</div>
                                ${renderPlanSummary(replan.previousPlan)}
                            </div>
                            <div class="plan-arrow">→</div>
                            <div class="plan-side">
                                <div class="plan-header new">New Plan (v${replan.newPlan?.version || '?'})</div>
                                ${renderPlanSummary(replan.newPlan)}
                            </div>
                        </div>
                    </div>
                `;
            }

            // LLM Prompt
            if (replan.llmPrompt) {
                html += `
                    <div class="modal-section">
                        <div class="modal-section-title collapsible" onclick="toggleSection(this)">
                            <span>LLM Prompt</span>
                            <span class="toggle-icon">▶</span>
                        </div>
                        <div class="collapsible-content" style="display: none;">
                            <div class="code-viewer">
                                <div class="code-viewer-content">
                                    <pre>${escapeHtml(replan.llmPrompt)}</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // LLM Response
            if (replan.llmResponse) {
                html += `
                    <div class="modal-section">
                        <div class="modal-section-title collapsible" onclick="toggleSection(this)">
                            <span>LLM Response (Raw JSON)</span>
                            <span class="toggle-icon">▶</span>
                        </div>
                        <div class="collapsible-content" style="display: none;">
                            <div class="code-viewer">
                                <div class="code-viewer-content">
                                    <pre>${formatJsonSafe(replan.llmResponse)}</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            document.getElementById('replan-modal-content').innerHTML = html;
            openModal('replan-modal');
        }

        function renderPlanSummary(plan) {
            if (!plan) return '<div class="plan-empty">No plan data</div>';

            let html = `<div class="plan-summary">`;
            html += `<div class="plan-name">${escapeHtml(plan.workflowName || 'Unnamed')}</div>`;
            html += `<div class="plan-entry">Entry: <span class="cyan">${escapeHtml(plan.entryPoint || '-')}</span></div>`;

            if (plan.nodes && plan.nodes.length > 0) {
                html += `<div class="plan-nodes-title">Nodes (${plan.nodes.length}):</div>`;
                html += `<div class="plan-nodes-list">`;
                for (const node of plan.nodes) {
                    html += `<div class="plan-node-item">
                        <span class="node-id">${escapeHtml(node.id)}</span>
                        <span class="node-type">${escapeHtml(node.agentType || '-')}</span>
                    </div>`;
                }
                html += `</div>`;
            }

            if (plan.edges && plan.edges.length > 0) {
                html += `<div class="plan-edges-title">Edges (${plan.edges.length}):</div>`;
                html += `<div class="plan-edges-list">`;
                for (const edge of plan.edges) {
                    const label = edge.conditionKey ? `[${edge.conditionKey}]` : '';
                    html += `<div class="plan-edge-item">
                        ${escapeHtml(edge.from)} → ${escapeHtml(edge.to)} ${label}
                    </div>`;
                }
                html += `</div>`;
            }

            html += `</div>`;
            return html;
        }

        function toggleSection(titleEl) {
            const content = titleEl.nextElementSibling;
            const icon = titleEl.querySelector('.toggle-icon');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                icon.textContent = '▼';
            } else {
                content.style.display = 'none';
                icon.textContent = '▶';
            }
        }

        function formatJsonSafe(str) {
            try {
                const parsed = JSON.parse(str);
                return escapeHtml(JSON.stringify(parsed, null, 2));
            } catch {
                return escapeHtml(str);
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // HISTORY MODAL
        // ═══════════════════════════════════════════════════════════════

        function openHistoryModal() {
            const history = currentState?.recentHistory || [];

            let html = '';
            if (history.length === 0) {
                html = '<div class="empty-state"><div class="empty-state-icon">&#128203;</div><div>No execution history</div></div>';
            } else {
                html = '<div class="history-grid">';
                for (const item of history) {
                    const selected = item.eventId === selectedEventId ? 'selected' : '';
                    html += `
                        <div class="history-card ${selected}" onclick="selectExecution('${item.eventId}')">
                            <div class="history-card-header">
                                <span class="history-card-title">${escapeHtml(truncate(item.workflowName || 'Unknown', 30))}</span>
                                <span class="history-status-badge ${item.state || 'UNKNOWN'}">${item.state || '-'}</span>
                            </div>
                            <div class="history-card-meta">
                                <span>${formatTime(item.startedAt)}</span>
                                <span>${formatDuration(item.durationMs)}</span>
                                ${item.replanCount > 0 ? `<span style="color: var(--accent-amber);">${item.replanCount} replans</span>` : ''}
                            </div>
                        </div>
                    `;
                }
                html += '</div>';
            }

            document.getElementById('history-modal-content').innerHTML = html;
            openModal('history-modal');
        }

        function selectExecution(eventId) {
            selectedEventId = eventId;
            closeModal();
            fetchState();
        }

        function backToLive() {
            selectedEventId = null;
            fetchState();
        }

        // ═══════════════════════════════════════════════════════════════
        // GRAPH RENDERING
        // ═══════════════════════════════════════════════════════════════

        function buildMermaidDiagram(graph) {
            if (!graph || !graph.nodes || graph.nodes.length === 0) return null;

            let diagram = 'flowchart TD\n';

            for (const node of graph.nodes) {
                const status = (node.status || 'PENDING').toLowerCase();
                const nodeIdSafe = node.id.replace(/__/g, '');
                let label;
                if (node.id === '__orchestrator__') {
                    label = `ORCHESTRATOR<br/><small>Plans Workflow</small>`;
                } else {
                    label = `${node.id}<br/><small>${node.agentType}</small>`;
                }
                diagram += `    ${nodeIdSafe}["${label}"]:::node${status}\n`;
            }

            diagram += '    END((End)):::endNode\n';

            for (const edge of graph.edges) {
                const from = edge.from.replace(/__/g, '');
                const to = edge.to === 'END' ? 'END' : edge.to.replace(/__/g, '');
                const label = edge.label ? `|${edge.label}|` : '';
                diagram += `    ${from} -->${label} ${to}\n`;
            }

            // Connect terminal nodes to END
            const nodesWithOutgoing = new Set(graph.edges.map(e => e.from));
            const terminalNodes = graph.nodes.filter(n =>
                n.id !== '__orchestrator__' && !nodesWithOutgoing.has(n.id)
            );
            for (const node of terminalNodes) {
                const nodeIdSafe = node.id.replace(/__/g, '');
                diagram += `    ${nodeIdSafe} --> END\n`;
            }

            diagram += `
    classDef endNode fill:#0c0c14,stroke:#00ff9d,stroke-width:2px,color:#00ff9d
    classDef nodepending fill:#1e1e2c,stroke:#282840,color:#707090
    classDef noderunning fill:#2a2040,stroke:#b366ff,stroke-width:2px,color:#f0f0f8
    classDef nodecompleted fill:#1a2e20,stroke:#00ff9d,color:#f0f0f8
    classDef nodeescalated fill:#2e2a1a,stroke:#ffb800,color:#f0f0f8
    classDef nodefailed fill:#2e1a1a,stroke:#ff3d6e,color:#f0f0f8
    classDef nodereplanned fill:#1a2030,stroke:#00e5ff,stroke-width:2px,color:#00e5ff
`;

            return diagram;
        }

        async function renderGraph() {
            const container = document.getElementById('mermaid-container');
            const noWorkflow = document.getElementById('no-workflow');

            if (!currentState?.graph?.nodes?.length) {
                container.innerHTML = '';
                noWorkflow.style.display = 'block';
                currentViewedEventId = null;
                savedTransform = null;
                return;
            }

            noWorkflow.style.display = 'none';

            const diagram = buildMermaidDiagram(currentState.graph);
            if (!diagram) return;

            // Determine if we're viewing the same execution or switching to a new one
            const newEventId = currentState?.currentExecution?.eventId || currentState?.triggerEvent?.id || 'current';
            const isSameExecution = (currentViewedEventId === newEventId);

            // Save current transform if viewing same execution
            if (isSameExecution && panzoomInstance) {
                savedTransform = panzoomInstance.getTransform();
            } else {
                // Switching executions - reset saved transform
                savedTransform = null;
            }

            try {
                // Dispose panzoom before clearing
                if (panzoomInstance) {
                    panzoomInstance.dispose();
                    panzoomInstance = null;
                }

                // Reset wrapper transform and clear content
                const wrapper = document.getElementById('graph-wrapper');
                wrapper.style.transform = '';
                container.innerHTML = '';

                const { svg } = await mermaid.render('graph-' + Date.now(), diagram);
                container.innerHTML = svg;

                // Make nodes clickable
                container.querySelectorAll('.node').forEach(node => {
                    node.style.cursor = 'pointer';
                    node.addEventListener('click', () => {
                        const nodeId = node.id.replace('flowchart-', '').split('-')[0];
                        if (nodeId !== 'END' && nodeId !== 'orchestrator') {
                            openNodeModal(nodeId);
                        }
                    });
                });

                // Update tracked event ID
                currentViewedEventId = newEventId;

                // Re-init panzoom and restore/center position
                initPanzoom(isSameExecution);
            } catch (err) {
                console.error('Mermaid error:', err);
                container.innerHTML = `<div style="color: var(--accent-red); padding: 20px;">Graph render error: ${err.message}</div>`;
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // RENDER UI
        // ═══════════════════════════════════════════════════════════════

        function renderEventBadge() {
            const badge = document.getElementById('event-badge');
            const event = currentState?.triggerEvent;

            if (!event) {
                badge.classList.remove('visible');
                return;
            }

            badge.classList.add('visible');
            document.getElementById('event-type-tag').textContent = event.eventType || '-';
            document.getElementById('event-source-text').textContent = `Source: ${event.source || '-'}`;
        }

        function renderTimeline() {
            const container = document.getElementById('timeline-scroll');
            const timeline = currentState?.timeline || [];
            const replans = currentState?.replans || [];

            if (timeline.length === 0 && replans.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">&#8987;</div>
                        <div>No activity yet</div>
                    </div>
                `;
                return;
            }

            let html = '';

            // Node executions
            if (timeline.length > 0) {
                html += `<div class="timeline-section"><div class="timeline-section-label">Node Executions</div>`;

                for (const node of timeline) {
                    const status = (node.status || 'PENDING').toLowerCase();
                    html += `
                        <div class="timeline-item ${status}" onclick="openNodeModal('${node.nodeId}')">
                            <div class="timeline-item-header">
                                <span class="timeline-node-name">${escapeHtml(node.nodeId)}</span>
                                <span class="timeline-agent-tag">${node.agentType || '-'}</span>
                            </div>
                            <div class="timeline-item-meta">
                                <span>${formatTime(node.startedAt)}</span>
                                <span>${formatDuration(node.durationMs)}</span>
                            </div>
                            ${node.escalationReason ? `<div class="timeline-escalation-badge">${escapeHtml(truncate(node.escalationReason, 50))}</div>` : ''}
                        </div>
                    `;
                }

                html += '</div>';
            }

            // Replans
            if (replans.length > 0) {
                html += `<div class="timeline-section"><div class="timeline-section-label">Replan Events</div>`;

                for (let i = 0; i < replans.length; i++) {
                    const replan = replans[i];
                    html += `
                        <div class="replan-item" onclick="openReplanModal(${i})">
                            <div class="replan-header">
                                <span class="replan-tag">REPLAN #${replan.replanNumber}</span>
                                <span class="replan-action">${replan.action || '-'}</span>
                            </div>
                            <div class="replan-trigger">Triggered by: <strong>${escapeHtml(replan.triggerNodeId || '-')}</strong></div>
                        </div>
                    `;
                }

                html += '</div>';
            }

            container.innerHTML = html;
        }

        function renderFooter() {
            const exec = currentState?.currentExecution;

            if (!exec) {
                document.getElementById('exec-event-id').textContent = '-';
                document.getElementById('exec-workflow').textContent = '-';
                document.getElementById('exec-status').textContent = '-';
                document.getElementById('exec-status').className = 'exec-value';
                document.getElementById('exec-duration').textContent = '-';
                document.getElementById('exec-replans').textContent = '0';
                return;
            }

            document.getElementById('exec-event-id').textContent = truncate(exec.eventId, 12) || '-';
            document.getElementById('exec-workflow').textContent = truncate(exec.workflowName, 30) || '-';

            const statusEl = document.getElementById('exec-status');
            const status = exec.state || 'UNKNOWN';
            statusEl.textContent = status;
            statusEl.className = `exec-value ${status.toLowerCase()}`;

            document.getElementById('exec-duration').textContent = formatDuration(exec.durationMs);
            document.getElementById('exec-replans').textContent = exec.replanCount || 0;

            // Show/hide back to live button
            document.getElementById('back-to-live').classList.toggle('visible', !!selectedEventId);
        }

        function updateStatus() {
            const dot = document.getElementById('status-dot');
            const label = document.getElementById('status-label');

            dot.classList.remove('ready', 'active');

            if (!currentState) {
                label.textContent = 'Disconnected';
                return;
            }

            if (currentState.hasActiveExecution) {
                dot.classList.add('active');
                label.textContent = 'Processing';
            } else {
                dot.classList.add('ready');
                label.textContent = 'Ready';
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // DATA FETCHING
        // ═══════════════════════════════════════════════════════════════

        async function fetchState() {
            try {
                const url = selectedEventId
                    ? `/api/v1/debug/${selectedEventId}`
                    : '/api/v1/debug/state';

                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                currentState = await response.json();

                updateStatus();
                renderEventBadge();
                renderGraph();
                renderTimeline();
                renderFooter();

            } catch (err) {
                console.error('Fetch error:', err);
                updateStatus();
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // INITIALIZATION
        // ═══════════════════════════════════════════════════════════════

        // Initial fetch on page load (no auto-polling)
        document.addEventListener('DOMContentLoaded', fetchState);

        // Close modal on Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && activeModal) closeModal();
        });
    </script>
</body>
</html>
