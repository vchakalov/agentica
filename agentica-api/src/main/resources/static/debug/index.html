<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentica Mission Control</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Outfit:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script src="https://unpkg.com/panzoom@9.4.3/dist/panzoom.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --bg-void: #05060a;
            --bg-primary: #0a0c12;
            --bg-secondary: #0f1218;
            --bg-tertiary: #141820;
            --bg-elevated: #1a1f28;
            --bg-modal: #0d0f14;
            --border-subtle: #1a1f2a;
            --border-default: #242a38;
            --border-accent: #2e3648;
            --text-primary: #eaedf3;
            --text-secondary: #9ca3b4;
            --text-muted: #5c6478;
            --text-dim: #3a4052;
            --accent-teal: #14b8a6;
            --accent-teal-dim: rgba(20, 184, 166, 0.15);
            --accent-emerald: #10b981;
            --accent-emerald-dim: rgba(16, 185, 129, 0.15);
            --accent-violet: #8b5cf6;
            --accent-violet-dim: rgba(139, 92, 246, 0.15);
            --accent-amber: #f59e0b;
            --accent-amber-dim: rgba(245, 158, 11, 0.15);
            --accent-rose: #f43f5e;
            --accent-rose-dim: rgba(244, 63, 94, 0.15);
            --accent-sky: #0ea5e9;
            --accent-sky-dim: rgba(14, 165, 233, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-void);
            color: var(--text-primary);
            min-height: 100vh;
            font-size: 12px;
            line-height: 1.5;
            overflow: hidden;
        }

        .container {
            display: grid;
            grid-template-rows: 56px 1fr 52px;
            height: 100vh;
            background: linear-gradient(135deg, var(--bg-void) 0%, #080a10 100%);
        }

        /* ═══════════════════════════════════════════════════════════════════
           HEADER
           ═══════════════════════════════════════════════════════════════════ */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-subtle);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-mark {
            width: 28px;
            height: 28px;
            border: 2px solid var(--accent-teal);
            border-radius: 6px;
            display: grid;
            place-items: center;
            font-size: 12px;
            color: var(--accent-teal);
            background: var(--accent-teal-dim);
        }

        .logo-text {
            font-family: 'Outfit', sans-serif;
            font-size: 15px;
            font-weight: 700;
            letter-spacing: 1.5px;
            color: var(--text-primary);
        }

        .logo-sub {
            font-size: 9px;
            color: var(--text-muted);
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* Event Badge - Compact clickable */
        .event-badge {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 6px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-default);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .event-badge.visible { display: flex; }

        .event-badge:hover {
            background: var(--bg-elevated);
            border-color: var(--accent-teal);
        }

        .event-badge-type {
            font-size: 10px;
            font-weight: 600;
            color: var(--accent-teal);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .event-badge-source {
            font-size: 10px;
            color: var(--text-muted);
        }

        .event-badge-arrow {
            color: var(--text-dim);
            font-size: 10px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .status-pill {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-dim);
        }

        .status-dot.ready { background: var(--accent-emerald); box-shadow: 0 0 8px var(--accent-emerald); }
        .status-dot.active { background: var(--accent-violet); box-shadow: 0 0 8px var(--accent-violet); animation: pulse 2s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.15); }
        }

        .status-label {
            font-size: 10px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .time-display {
            font-size: 11px;
            color: var(--text-muted);
            font-variant-numeric: tabular-nums;
        }

        /* ═══════════════════════════════════════════════════════════════════
           MAIN LAYOUT
           ═══════════════════════════════════════════════════════════════════ */
        .main {
            display: grid;
            grid-template-columns: 1fr 340px;
            overflow: hidden;
        }

        /* Graph Panel - Now full height */
        .graph-panel {
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            border-right: 1px solid var(--border-subtle);
            position: relative;
        }

        .graph-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-subtle);
        }

        .graph-title {
            font-family: 'Outfit', sans-serif;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-muted);
        }

        .graph-hint {
            font-size: 10px;
            color: var(--text-dim);
        }

        .graph-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background:
                radial-gradient(ellipse at 30% 20%, rgba(20, 184, 166, 0.03) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 80%, rgba(139, 92, 246, 0.03) 0%, transparent 50%),
                repeating-linear-gradient(0deg, transparent, transparent 49px, var(--border-subtle) 49px, var(--border-subtle) 50px),
                repeating-linear-gradient(90deg, transparent, transparent 49px, var(--border-subtle) 49px, var(--border-subtle) 50px);
        }

        .graph-wrapper {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .no-workflow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: var(--text-dim);
        }

        .no-workflow-icon {
            font-size: 40px;
            opacity: 0.3;
            margin-bottom: 12px;
            animation: float 4s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .graph-controls {
            position: absolute;
            bottom: 16px;
            right: 16px;
            display: flex;
            gap: 6px;
        }

        .graph-btn {
            width: 36px;
            height: 36px;
            border: 1px solid var(--border-default);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.15s ease;
        }

        .graph-btn:hover {
            background: var(--bg-elevated);
            border-color: var(--accent-teal);
            color: var(--accent-teal);
        }

        .zoom-indicator {
            position: absolute;
            bottom: 16px;
            left: 16px;
            font-size: 10px;
            color: var(--text-dim);
            background: var(--bg-secondary);
            padding: 4px 10px;
            border-radius: 4px;
            border: 1px solid var(--border-subtle);
        }

        /* Right Panel - Timeline */
        .timeline-panel {
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            overflow: hidden;
        }

        .timeline-header {
            padding: 10px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-subtle);
        }

        .timeline-title {
            font-family: 'Outfit', sans-serif;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-muted);
        }

        .timeline-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .timeline-scroll::-webkit-scrollbar { width: 5px; }
        .timeline-scroll::-webkit-scrollbar-track { background: var(--bg-secondary); }
        .timeline-scroll::-webkit-scrollbar-thumb { background: var(--border-accent); border-radius: 3px; }

        .timeline-section {
            margin-bottom: 20px;
        }

        .timeline-section-label {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-dim);
            margin-bottom: 8px;
            padding-left: 4px;
        }

        .timeline-item {
            padding: 12px 14px;
            margin-bottom: 8px;
            background: var(--bg-secondary);
            border-radius: 8px;
            border-left: 3px solid var(--text-dim);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .timeline-item:hover { background: var(--bg-tertiary); }

        .timeline-item.completed { border-left-color: var(--accent-emerald); }
        .timeline-item.running { border-left-color: var(--accent-violet); background: var(--accent-violet-dim); }
        .timeline-item.escalated { border-left-color: var(--accent-amber); }
        .timeline-item.failed { border-left-color: var(--accent-rose); }

        .timeline-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .timeline-item-name {
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            font-size: 12px;
            color: var(--text-primary);
        }

        .timeline-item-badge {
            font-size: 9px;
            padding: 2px 6px;
            background: var(--bg-primary);
            border-radius: 3px;
            color: var(--accent-teal);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .timeline-item-meta {
            display: flex;
            gap: 12px;
            font-size: 10px;
            color: var(--text-muted);
        }

        .timeline-item-escalation {
            margin-top: 8px;
            padding: 8px 10px;
            background: var(--accent-amber-dim);
            border-radius: 4px;
            font-size: 10px;
            color: var(--accent-amber);
        }

        /* Replan Items */
        .replan-item {
            padding: 12px 14px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--accent-amber-dim) 0%, transparent 100%);
            border-radius: 8px;
            border: 1px solid rgba(245, 158, 11, 0.2);
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .replan-item:hover { border-color: var(--accent-amber); }

        .replan-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .replan-badge {
            font-size: 9px;
            font-weight: 600;
            padding: 2px 6px;
            background: var(--accent-amber);
            color: var(--bg-void);
            border-radius: 3px;
        }

        .replan-action {
            font-size: 10px;
            color: var(--text-secondary);
        }

        .replan-trigger {
            font-size: 10px;
            color: var(--accent-rose);
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 32px;
            color: var(--text-dim);
            text-align: center;
        }

        .empty-state-icon {
            font-size: 24px;
            opacity: 0.4;
            margin-bottom: 8px;
        }

        /* ═══════════════════════════════════════════════════════════════════
           FOOTER
           ═══════════════════════════════════════════════════════════════════ */
        .footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-subtle);
        }

        .exec-info {
            display: none;
            align-items: center;
            gap: 24px;
        }

        .exec-info.visible { display: flex; }

        .exec-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .exec-label {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-dim);
        }

        .exec-value {
            font-size: 11px;
            color: var(--text-primary);
        }

        .exec-value.running { color: var(--accent-violet); }
        .exec-value.completed { color: var(--accent-emerald); }
        .exec-value.failed { color: var(--accent-rose); }

        .history-scroll {
            display: flex;
            align-items: center;
            gap: 8px;
            overflow-x: auto;
            padding: 8px 0;
            max-width: 50%;
        }

        .history-scroll::-webkit-scrollbar { height: 3px; }
        .history-scroll::-webkit-scrollbar-thumb { background: var(--border-accent); border-radius: 2px; }

        .history-chip {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 10px;
            color: var(--text-secondary);
        }

        .history-chip:hover { border-color: var(--border-accent); }
        .history-chip.selected { border-color: var(--accent-teal); }

        .history-chip-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .history-chip-dot.COMPLETED { background: var(--accent-emerald); }
        .history-chip-dot.FAILED { background: var(--accent-rose); }
        .history-chip-dot.RUNNING { background: var(--accent-violet); }
        .history-chip-dot.ABORTED { background: var(--accent-amber); }

        .back-btn {
            font-size: 10px;
            color: var(--accent-teal);
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
        }

        .back-btn:hover { text-decoration: underline; }

        /* ═══════════════════════════════════════════════════════════════════
           MODALS
           ═══════════════════════════════════════════════════════════════════ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(5, 6, 10, 0.85);
            backdrop-filter: blur(4px);
            display: none;
            place-items: center;
            z-index: 1000;
            padding: 24px;
        }

        .modal-overlay.visible { display: grid; }

        .modal {
            background: var(--bg-modal);
            border: 1px solid var(--border-default);
            border-radius: 12px;
            width: 100%;
            max-width: 720px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 24px 64px rgba(0, 0, 0, 0.5);
            animation: modalIn 0.2s ease;
        }

        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.96) translateY(8px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .modal-title {
            font-family: 'Outfit', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-tertiary);
            color: var(--text-muted);
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.15s ease;
        }

        .modal-close:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .modal-body::-webkit-scrollbar { width: 5px; }
        .modal-body::-webkit-scrollbar-thumb { background: var(--border-accent); border-radius: 3px; }

        /* Modal Sections */
        .modal-section {
            margin-bottom: 24px;
        }

        .modal-section:last-child { margin-bottom: 0; }

        .modal-section-title {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-section-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border-subtle);
        }

        .modal-grid {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 8px 16px;
        }

        .modal-label {
            font-size: 11px;
            color: var(--text-muted);
        }

        .modal-value {
            font-size: 11px;
            color: var(--text-primary);
            word-break: break-word;
        }

        .modal-value.accent-teal { color: var(--accent-teal); }
        .modal-value.accent-amber { color: var(--accent-amber); }
        .modal-value.accent-rose { color: var(--accent-rose); }
        .modal-value.accent-emerald { color: var(--accent-emerald); }
        .modal-value.accent-violet { color: var(--accent-violet); }

        /* Code Viewer */
        .code-viewer {
            background: var(--bg-void);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            overflow: hidden;
        }

        .code-viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-subtle);
        }

        .code-viewer-label {
            font-size: 10px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .code-viewer-copy {
            font-size: 10px;
            color: var(--accent-teal);
            background: none;
            border: none;
            cursor: pointer;
        }

        .code-viewer-copy:hover { text-decoration: underline; }

        .code-viewer-content {
            padding: 12px 14px;
            font-size: 11px;
            line-height: 1.6;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }

        .code-viewer-content pre {
            margin: 0;
            background: transparent !important;
        }

        .code-viewer-content code {
            background: transparent !important;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
        }

        /* Markdown Viewer */
        .md-viewer {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 16px;
            font-size: 12px;
            line-height: 1.7;
            color: var(--text-secondary);
        }

        .md-viewer h1, .md-viewer h2, .md-viewer h3 {
            color: var(--text-primary);
            margin: 16px 0 8px;
            font-family: 'Outfit', sans-serif;
        }

        .md-viewer h1 { font-size: 18px; }
        .md-viewer h2 { font-size: 15px; }
        .md-viewer h3 { font-size: 13px; }

        .md-viewer p { margin: 8px 0; }
        .md-viewer ul, .md-viewer ol { padding-left: 20px; margin: 8px 0; }
        .md-viewer code { background: var(--bg-void); padding: 2px 6px; border-radius: 3px; font-size: 11px; }
        .md-viewer pre { background: var(--bg-void); padding: 12px; border-radius: 6px; overflow-x: auto; margin: 12px 0; }
        .md-viewer pre code { padding: 0; }

        /* Token Badges */
        .token-badges {
            display: flex;
            gap: 8px;
        }

        .token-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            font-size: 10px;
        }

        .token-badge.input { color: var(--accent-emerald); }
        .token-badge.output { color: var(--accent-violet); }

        /* LLM Message */
        .llm-message {
            margin-bottom: 12px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-subtle);
        }

        .llm-message-header {
            padding: 8px 12px;
            background: var(--bg-tertiary);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-dim);
            border-bottom: 1px solid var(--border-subtle);
        }

        .llm-message.system .llm-message-header { color: var(--accent-teal); }
        .llm-message.user .llm-message-header { color: var(--accent-emerald); }
        .llm-message.assistant .llm-message-header { color: var(--accent-violet); }

        .llm-message-content {
            padding: 12px;
            font-size: 11px;
            color: var(--text-secondary);
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        /* Tool Call */
        .tool-call {
            margin-bottom: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-subtle);
            overflow: hidden;
        }

        .tool-call-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-subtle);
        }

        .tool-call-name {
            font-weight: 600;
            color: var(--accent-sky);
            font-size: 11px;
        }

        .tool-call-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 10px;
            color: var(--text-muted);
        }

        .tool-call-status {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 600;
        }

        .tool-call-status.success { background: var(--accent-emerald-dim); color: var(--accent-emerald); }
        .tool-call-status.error { background: var(--accent-rose-dim); color: var(--accent-rose); }

        .tool-call-body {
            padding: 12px;
        }

        .tool-call-section {
            margin-bottom: 10px;
        }

        .tool-call-section:last-child { margin-bottom: 0; }

        .tool-call-section-label {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-dim);
            margin-bottom: 6px;
        }

        /* Payload Grid */
        .payload-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px;
        }

        .payload-item {
            padding: 10px 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
        }

        .payload-key {
            font-size: 9px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .payload-value {
            font-size: 11px;
            color: var(--text-primary);
            word-break: break-word;
        }

        /* Tabs */
        .modal-tabs {
            display: flex;
            gap: 4px;
            padding: 0 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-subtle);
        }

        .modal-tab {
            padding: 10px 16px;
            font-size: 11px;
            color: var(--text-muted);
            background: none;
            border: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
            transition: all 0.15s ease;
        }

        .modal-tab:hover { color: var(--text-secondary); }
        .modal-tab.active { color: var(--accent-teal); border-bottom-color: var(--accent-teal); }

        /* Mermaid Overrides */
        .mermaid { background: transparent !important; }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="logo">
                    <div class="logo-mark">◆</div>
                    <div>
                        <div class="logo-text">AGENTICA</div>
                        <div class="logo-sub">Mission Control</div>
                    </div>
                </div>
                <div id="event-badge" class="event-badge" onclick="openEventModal()">
                    <span id="event-badge-type" class="event-badge-type">-</span>
                    <span id="event-badge-source" class="event-badge-source">-</span>
                    <span class="event-badge-arrow">▸</span>
                </div>
            </div>
            <div class="header-right">
                <div class="status-pill">
                    <div id="status-dot" class="status-dot"></div>
                    <span id="status-label" class="status-label">Initializing</span>
                </div>
                <span id="time-display" class="time-display">--:--:--</span>
            </div>
        </header>

        <!-- Main -->
        <main class="main">
            <!-- Graph Panel -->
            <div class="graph-panel">
                <div class="graph-header">
                    <span class="graph-title">Workflow Graph</span>
                    <span class="graph-hint">Scroll to zoom • Drag to pan</span>
                </div>
                <div id="graph-container" class="graph-container">
                    <div id="graph-wrapper" class="graph-wrapper">
                        <div id="mermaid-container"></div>
                    </div>
                    <div id="no-workflow" class="no-workflow">
                        <div class="no-workflow-icon">◇</div>
                        <div>Awaiting Workflow</div>
                        <div style="font-size: 10px; margin-top: 4px;">Send an event to begin</div>
                    </div>
                    <div class="graph-controls">
                        <button class="graph-btn" onclick="zoomIn()" title="Zoom In">+</button>
                        <button class="graph-btn" onclick="zoomOut()" title="Zoom Out">−</button>
                        <button class="graph-btn" onclick="resetZoom()" title="Reset">⟲</button>
                    </div>
                    <div id="zoom-indicator" class="zoom-indicator">100%</div>
                </div>
            </div>

            <!-- Timeline Panel -->
            <div class="timeline-panel">
                <div class="timeline-header">
                    <span class="timeline-title">Execution Timeline</span>
                </div>
                <div id="timeline-scroll" class="timeline-scroll">
                    <div class="empty-state">
                        <div class="empty-state-icon">◌</div>
                        <div>No activity</div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div id="exec-info" class="exec-info">
                <div class="exec-item">
                    <span class="exec-label">Event</span>
                    <span id="exec-event-id" class="exec-value">-</span>
                </div>
                <div class="exec-item">
                    <span class="exec-label">Workflow</span>
                    <span id="exec-workflow" class="exec-value">-</span>
                </div>
                <div class="exec-item">
                    <span class="exec-label">Status</span>
                    <span id="exec-status" class="exec-value">-</span>
                </div>
                <div class="exec-item">
                    <span class="exec-label">Duration</span>
                    <span id="exec-duration" class="exec-value">-</span>
                </div>
                <div class="exec-item">
                    <span class="exec-label">Replans</span>
                    <span id="exec-replans" class="exec-value">0</span>
                </div>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
                <button id="back-btn" class="back-btn" style="display: none;" onclick="clearSelection()">← Live View</button>
                <div id="history-scroll" class="history-scroll"></div>
            </div>
        </footer>
    </div>

    <!-- Event Modal -->
    <div id="event-modal" class="modal-overlay" onclick="closeModal(event, 'event-modal')">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span class="modal-title">Event Details</span>
                <button class="modal-close" onclick="closeModalById('event-modal')">×</button>
            </div>
            <div id="event-modal-body" class="modal-body"></div>
        </div>
    </div>

    <!-- Node Modal -->
    <div id="node-modal" class="modal-overlay" onclick="closeModal(event, 'node-modal')">
        <div class="modal" style="max-width: 800px;" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span id="node-modal-title" class="modal-title">Node Details</span>
                <button class="modal-close" onclick="closeModalById('node-modal')">×</button>
            </div>
            <div id="node-modal-tabs" class="modal-tabs"></div>
            <div id="node-modal-body" class="modal-body"></div>
        </div>
    </div>

    <!-- Replan Modal -->
    <div id="replan-modal" class="modal-overlay" onclick="closeModal(event, 'replan-modal')">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span id="replan-modal-title" class="modal-title">Replan Details</span>
                <button class="modal-close" onclick="closeModalById('replan-modal')">×</button>
            </div>
            <div id="replan-modal-body" class="modal-body"></div>
        </div>
    </div>

    <script>
        // Initialize
        mermaid.initialize({
            startOnLoad: false,
            theme: 'dark',
            themeVariables: {
                primaryColor: '#141820',
                primaryTextColor: '#eaedf3',
                primaryBorderColor: '#242a38',
                lineColor: '#2e3648',
                secondaryColor: '#0f1218',
                tertiaryColor: '#0a0c12',
                background: 'transparent',
                mainBkg: '#141820',
                nodeBorder: '#242a38'
            },
            flowchart: { curve: 'basis', padding: 20, nodeSpacing: 50, rankSpacing: 60 }
        });

        let currentState = null;
        let selectedEventId = null;
        let panzoomInstance = null;

        // Panzoom
        function initPanzoom() {
            const wrapper = document.getElementById('graph-wrapper');
            if (panzoomInstance) panzoomInstance.dispose();
            panzoomInstance = panzoom(wrapper, {
                maxZoom: 5, minZoom: 0.2, initialZoom: 1,
                bounds: false, boundsPadding: 0.1, smoothScroll: false
            });
            panzoomInstance.on('zoom', e => {
                document.getElementById('zoom-indicator').textContent = Math.round(e.getTransform().scale * 100) + '%';
            });
        }

        function zoomIn() { if (panzoomInstance) { const t = panzoomInstance.getTransform(); panzoomInstance.zoomTo(t.x, t.y, t.scale * 1.2); } }
        function zoomOut() { if (panzoomInstance) { const t = panzoomInstance.getTransform(); panzoomInstance.zoomTo(t.x, t.y, t.scale * 0.8); } }
        function resetZoom() { if (panzoomInstance) { panzoomInstance.moveTo(0, 0); panzoomInstance.zoomAbs(0, 0, 1); } }

        // Utilities
        function formatDuration(ms) {
            if (!ms || ms === 0) return '-';
            if (ms < 1000) return ms + 'ms';
            if (ms < 60000) return (ms / 1000).toFixed(1) + 's';
            return (ms / 60000).toFixed(1) + 'm';
        }

        function formatTime(ts) { return ts ? new Date(ts).toLocaleTimeString() : '-'; }

        function truncate(s, n) { return s && s.length > n ? s.substring(0, n) + '…' : (s || ''); }

        function escapeHtml(s) {
            if (!s) return '';
            const d = document.createElement('div');
            d.textContent = s;
            return d.innerHTML;
        }

        function updateTime() {
            document.getElementById('time-display').textContent = new Date().toLocaleTimeString();
        }
        setInterval(updateTime, 1000);
        updateTime();

        // Modal System
        function openModal(id) { document.getElementById(id).classList.add('visible'); }
        function closeModalById(id) { document.getElementById(id).classList.remove('visible'); }
        function closeModal(e, id) { if (e.target.classList.contains('modal-overlay')) closeModalById(id); }

        function openEventModal() {
            if (!currentState?.triggerEvent) return;
            const ev = currentState.triggerEvent;
            let html = `
                <div class="modal-section">
                    <div class="modal-section-title">Event Information</div>
                    <div class="modal-grid">
                        <span class="modal-label">Event ID</span>
                        <span class="modal-value">${escapeHtml(ev.id)}</span>
                        <span class="modal-label">Type</span>
                        <span class="modal-value accent-teal">${escapeHtml(ev.eventType)}</span>
                        <span class="modal-label">Source</span>
                        <span class="modal-value">${escapeHtml(ev.source)}</span>
                        <span class="modal-label">Received</span>
                        <span class="modal-value">${formatTime(ev.receivedAt)}</span>
                        ${ev.externalId ? `<span class="modal-label">External ID</span><span class="modal-value">${escapeHtml(ev.externalId)}</span>` : ''}
                        ${ev.category ? `<span class="modal-label">Category</span><span class="modal-value">${escapeHtml(ev.category)}</span>` : ''}
                        ${ev.priority ? `<span class="modal-label">Priority</span><span class="modal-value">${ev.priority}</span>` : ''}
                    </div>
                </div>
            `;

            if (ev.payload && Object.keys(ev.payload).length > 0) {
                html += `
                    <div class="modal-section">
                        <div class="modal-section-title">Payload</div>
                        <div class="payload-grid">
                            ${Object.entries(ev.payload).map(([k, v]) => `
                                <div class="payload-item">
                                    <div class="payload-key">${escapeHtml(k)}</div>
                                    <div class="payload-value">${escapeHtml(typeof v === 'object' ? JSON.stringify(v) : String(v))}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="modal-section">
                        <div class="modal-section-title">Raw Payload (JSON)</div>
                        <div class="code-viewer">
                            <div class="code-viewer-header">
                                <span class="code-viewer-label">JSON</span>
                                <button class="code-viewer-copy" onclick="copyToClipboard(\`${escapeHtml(JSON.stringify(ev.payload, null, 2))}\`)">Copy</button>
                            </div>
                            <div class="code-viewer-content"><pre><code class="language-json">${escapeHtml(JSON.stringify(ev.payload, null, 2))}</code></pre></div>
                        </div>
                    </div>
                `;
            }

            document.getElementById('event-modal-body').innerHTML = html;
            hljs.highlightAll();
            openModal('event-modal');
        }

        function openNodeModal(nodeId) {
            const node = currentState?.timeline?.find(n => n.nodeId === nodeId);
            if (!node) return;

            document.getElementById('node-modal-title').textContent = `Node: ${node.nodeId}`;

            // Build tabs
            const hasLLM = node.agentExecutions?.some(e => e.llmInteraction);
            const hasTools = node.agentExecutions?.some(e => e.toolCalls?.length > 0);
            const hasOutput = node.output;
            const hasEscalation = node.escalationReason;

            let tabs = ['Overview'];
            if (hasLLM) tabs.push('LLM');
            if (hasTools) tabs.push('Tools');
            if (hasOutput) tabs.push('Output');
            if (hasEscalation) tabs.push('Escalation');

            document.getElementById('node-modal-tabs').innerHTML = tabs.map((t, i) =>
                `<button class="modal-tab${i === 0 ? ' active' : ''}" onclick="switchNodeTab('${t}', this)">${t}</button>`
            ).join('');

            renderNodeTab('Overview', node);
            openModal('node-modal');
        }

        function switchNodeTab(tab, btn) {
            document.querySelectorAll('#node-modal-tabs .modal-tab').forEach(t => t.classList.remove('active'));
            btn.classList.add('active');
            const node = currentState?.timeline?.find(n => n.nodeId === document.getElementById('node-modal-title').textContent.replace('Node: ', ''));
            if (node) renderNodeTab(tab, node);
        }

        function renderNodeTab(tab, node) {
            const body = document.getElementById('node-modal-body');
            let html = '';

            if (tab === 'Overview') {
                html = `
                    <div class="modal-section">
                        <div class="modal-section-title">Execution Details</div>
                        <div class="modal-grid">
                            <span class="modal-label">Node ID</span>
                            <span class="modal-value">${escapeHtml(node.nodeId)}</span>
                            <span class="modal-label">Agent Type</span>
                            <span class="modal-value accent-teal">${node.agentType || '-'}</span>
                            <span class="modal-label">Status</span>
                            <span class="modal-value ${node.status === 'COMPLETED' ? 'accent-emerald' : node.status === 'ESCALATED' ? 'accent-amber' : node.status === 'FAILED' ? 'accent-rose' : ''}">${node.status || '-'}</span>
                            <span class="modal-label">Started</span>
                            <span class="modal-value">${formatTime(node.startedAt)}</span>
                            <span class="modal-label">Duration</span>
                            <span class="modal-value">${formatDuration(node.durationMs)}</span>
                        </div>
                    </div>
                `;

                if (node.agentExecutions?.length > 0) {
                    const totalTokensIn = node.agentExecutions.reduce((sum, e) => sum + (e.llmInteraction?.inputTokens || 0), 0);
                    const totalTokensOut = node.agentExecutions.reduce((sum, e) => sum + (e.llmInteraction?.outputTokens || 0), 0);
                    const totalToolCalls = node.agentExecutions.reduce((sum, e) => sum + (e.toolCalls?.length || 0), 0);

                    html += `
                        <div class="modal-section">
                            <div class="modal-section-title">Summary</div>
                            <div class="modal-grid">
                                <span class="modal-label">LLM Calls</span>
                                <span class="modal-value">${node.agentExecutions.filter(e => e.llmInteraction).length}</span>
                                <span class="modal-label">Total Tokens</span>
                                <span class="modal-value">
                                    <span class="token-badge input">IN ${totalTokensIn}</span>
                                    <span class="token-badge output">OUT ${totalTokensOut}</span>
                                </span>
                                <span class="modal-label">Tool Calls</span>
                                <span class="modal-value">${totalToolCalls}</span>
                            </div>
                        </div>
                    `;
                }
            }

            else if (tab === 'LLM') {
                node.agentExecutions?.filter(e => e.llmInteraction).forEach((exec, i) => {
                    const llm = exec.llmInteraction;
                    html += `
                        <div class="modal-section">
                            <div class="modal-section-title">LLM Call ${i + 1} - ${exec.phase || 'Unknown Phase'}</div>
                            <div class="modal-grid" style="margin-bottom: 16px;">
                                <span class="modal-label">Model</span>
                                <span class="modal-value">${escapeHtml(llm.model || '-')}</span>
                                <span class="modal-label">Latency</span>
                                <span class="modal-value">${formatDuration(llm.latencyMs)}</span>
                                <span class="modal-label">Tokens</span>
                                <span class="modal-value token-badges">
                                    <span class="token-badge input">IN ${llm.inputTokens || 0}</span>
                                    <span class="token-badge output">OUT ${llm.outputTokens || 0}</span>
                                </span>
                            </div>
                    `;

                    if (llm.systemPrompt) {
                        html += `
                            <div style="margin-bottom: 16px;">
                                <div class="llm-message system">
                                    <div class="llm-message-header">System Prompt</div>
                                    <div class="llm-message-content">${escapeHtml(llm.systemPrompt)}</div>
                                </div>
                            </div>
                        `;
                    }

                    if (llm.messages?.length > 0) {
                        html += '<div style="margin-bottom: 16px;">';
                        llm.messages.forEach(m => {
                            html += `
                                <div class="llm-message ${m.role || 'unknown'}">
                                    <div class="llm-message-header">${m.role || 'Unknown'}</div>
                                    <div class="llm-message-content">${escapeHtml(m.content)}</div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }

                    if (llm.rawResponse) {
                        html += `
                            <div class="code-viewer">
                                <div class="code-viewer-header">
                                    <span class="code-viewer-label">Raw Response</span>
                                    <button class="code-viewer-copy" onclick="copyToClipboard(\`${escapeHtml(llm.rawResponse).replace(/`/g, '\\`')}\`)">Copy</button>
                                </div>
                                <div class="code-viewer-content"><pre><code>${escapeHtml(llm.rawResponse)}</code></pre></div>
                            </div>
                        `;
                    }

                    html += '</div>';
                });
            }

            else if (tab === 'Tools') {
                node.agentExecutions?.filter(e => e.toolCalls?.length > 0).forEach((exec, i) => {
                    html += `<div class="modal-section"><div class="modal-section-title">Tool Calls - ${exec.phase || 'Phase ' + (i + 1)}</div>`;
                    exec.toolCalls.forEach(tc => {
                        html += `
                            <div class="tool-call">
                                <div class="tool-call-header">
                                    <span class="tool-call-name">${escapeHtml(tc.toolName)}</span>
                                    <div class="tool-call-meta">
                                        <span>${formatDuration(tc.durationMs)}</span>
                                        <span class="tool-call-status ${tc.success ? 'success' : 'error'}">${tc.success ? 'SUCCESS' : 'ERROR'}</span>
                                    </div>
                                </div>
                                <div class="tool-call-body">
                                    ${tc.toolInput ? `
                                        <div class="tool-call-section">
                                            <div class="tool-call-section-label">Input</div>
                                            <div class="code-viewer">
                                                <div class="code-viewer-content"><pre><code class="language-json">${escapeHtml(tc.toolInput)}</code></pre></div>
                                            </div>
                                        </div>
                                    ` : ''}
                                    ${tc.toolOutput ? `
                                        <div class="tool-call-section">
                                            <div class="tool-call-section-label">Output</div>
                                            <div class="code-viewer">
                                                <div class="code-viewer-content"><pre><code>${escapeHtml(tc.toolOutput)}</code></pre></div>
                                            </div>
                                        </div>
                                    ` : ''}
                                    ${tc.error ? `
                                        <div class="tool-call-section">
                                            <div class="tool-call-section-label" style="color: var(--accent-rose);">Error</div>
                                            <div style="color: var(--accent-rose); font-size: 11px;">${escapeHtml(tc.error)}</div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                });
            }

            else if (tab === 'Output') {
                const output = node.output;
                const isJson = typeof output === 'object';
                const formatted = isJson ? JSON.stringify(output, null, 2) : String(output || '');

                html = `
                    <div class="modal-section">
                        <div class="modal-section-title">Node Output</div>
                        <div class="code-viewer">
                            <div class="code-viewer-header">
                                <span class="code-viewer-label">${isJson ? 'JSON' : 'Text'}</span>
                                <button class="code-viewer-copy" onclick="copyToClipboard(\`${escapeHtml(formatted).replace(/`/g, '\\`')}\`)">Copy</button>
                            </div>
                            <div class="code-viewer-content"><pre><code class="${isJson ? 'language-json' : ''}">${escapeHtml(formatted)}</code></pre></div>
                        </div>
                    </div>
                `;
            }

            else if (tab === 'Escalation') {
                html = `
                    <div class="modal-section">
                        <div class="modal-section-title">Escalation Details</div>
                        <div class="modal-grid">
                            <span class="modal-label">Reason</span>
                            <span class="modal-value accent-amber">${escapeHtml(node.escalationReason)}</span>
                        </div>
                    </div>
                `;

                if (node.escalationContext) {
                    html += `
                        <div class="modal-section">
                            <div class="modal-section-title">Context / Error</div>
                            <div class="code-viewer">
                                <div class="code-viewer-header">
                                    <span class="code-viewer-label">Error Details</span>
                                </div>
                                <div class="code-viewer-content" style="color: var(--accent-rose);"><pre>${escapeHtml(node.escalationContext)}</pre></div>
                            </div>
                        </div>
                    `;
                }
            }

            body.innerHTML = html;
            hljs.highlightAll();
        }

        function openReplanModal(idx) {
            const replan = currentState?.replans?.[idx];
            if (!replan) return;

            document.getElementById('replan-modal-title').textContent = `Replan #${replan.replanNumber}`;

            let html = `
                <div class="modal-section">
                    <div class="modal-section-title">Replan Information</div>
                    <div class="modal-grid">
                        <span class="modal-label">Replan #</span>
                        <span class="modal-value">${replan.replanNumber}</span>
                        <span class="modal-label">Action</span>
                        <span class="modal-value accent-amber">${replan.action || '-'}</span>
                        <span class="modal-label">Trigger Node</span>
                        <span class="modal-value accent-rose">${escapeHtml(replan.triggerNodeId || '-')}</span>
                        <span class="modal-label">Resume From</span>
                        <span class="modal-value">${escapeHtml(replan.resumeFrom || '-')}</span>
                        <span class="modal-label">Time</span>
                        <span class="modal-value">${formatTime(replan.timestamp)}</span>
                    </div>
                </div>

                <div class="modal-section">
                    <div class="modal-section-title">Escalation Reason</div>
                    <div class="code-viewer">
                        <div class="code-viewer-content">${escapeHtml(replan.escalationReason || 'No reason provided')}</div>
                    </div>
                </div>
            `;

            if (replan.escalationContext) {
                html += `
                    <div class="modal-section">
                        <div class="modal-section-title">Escalation Context (Error)</div>
                        <div class="code-viewer">
                            <div class="code-viewer-content" style="color: var(--accent-rose);">${escapeHtml(replan.escalationContext)}</div>
                        </div>
                    </div>
                `;
            }

            if (replan.guidance) {
                // Try to render as markdown
                const isMarkdown = replan.guidance.includes('#') || replan.guidance.includes('*') || replan.guidance.includes('-');
                html += `
                    <div class="modal-section">
                        <div class="modal-section-title">Orchestrator Guidance</div>
                        ${isMarkdown
                            ? `<div class="md-viewer">${marked.parse(replan.guidance)}</div>`
                            : `<div class="code-viewer"><div class="code-viewer-content">${escapeHtml(replan.guidance)}</div></div>`
                        }
                    </div>
                `;
            }

            if (replan.abortReason) {
                html += `
                    <div class="modal-section">
                        <div class="modal-section-title">Abort Reason</div>
                        <div class="code-viewer">
                            <div class="code-viewer-content" style="color: var(--accent-rose);">${escapeHtml(replan.abortReason)}</div>
                        </div>
                    </div>
                `;
            }

            document.getElementById('replan-modal-body').innerHTML = html;
            openModal('replan-modal');
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                // Could show a toast
            });
        }

        // Graph
        function buildMermaidDiagram(graph) {
            if (!graph?.nodes?.length) return null;

            let diagram = 'flowchart TD\n';
            diagram += '    START((Start)):::startNode\n';

            for (const node of graph.nodes) {
                const status = (node.status || 'PENDING').toLowerCase();
                const nodeIdSafe = node.id.replace(/__/g, '');
                let label;
                if (node.id === '__orchestrator__') {
                    label = `ORCHESTRATOR<br/><small>Plans Workflow</small>`;
                } else {
                    label = `${node.id}<br/><small>${node.agentType}</small>`;
                }
                diagram += `    ${nodeIdSafe}["${label}"]:::node${status}\n`;
            }

            diagram += '    END((End)):::endNode\n';

            const hasOrchestrator = graph.nodes.some(n => n.id === '__orchestrator__');
            if (hasOrchestrator) {
                diagram += `    START --> orchestrator\n`;
            }

            for (const edge of graph.edges) {
                const from = edge.from === 'START' ? 'START' : edge.from.replace(/__/g, '');
                const to = edge.to === 'END' ? 'END' : edge.to.replace(/__/g, '');
                const label = edge.label ? `|${edge.label}|` : '';
                diagram += `    ${from} -->${label} ${to}\n`;
            }

            const nodesWithOutgoing = new Set(graph.edges.map(e => e.from));
            graph.nodes.filter(n => n.id !== '__orchestrator__' && !nodesWithOutgoing.has(n.id)).forEach(n => {
                diagram += `    ${n.id.replace(/__/g, '')} --> END\n`;
            });

            diagram += `
    classDef startNode fill:#0f1218,stroke:#14b8a6,stroke-width:2px,color:#14b8a6
    classDef endNode fill:#0f1218,stroke:#10b981,stroke-width:2px,color:#10b981
    classDef nodepending fill:#141820,stroke:#242a38,color:#5c6478
    classDef noderunning fill:#1a1530,stroke:#8b5cf6,stroke-width:2px,color:#eaedf3
    classDef nodecompleted fill:#0f1a18,stroke:#10b981,color:#eaedf3
    classDef nodeescalated fill:#1a1810,stroke:#f59e0b,color:#eaedf3
    classDef nodefailed fill:#1a1015,stroke:#f43f5e,color:#eaedf3
    classDef nodereplanned fill:#101820,stroke:#0ea5e9,stroke-width:2px,color:#0ea5e9
`;
            return diagram;
        }

        async function renderGraph(state) {
            const container = document.getElementById('mermaid-container');
            const noWorkflow = document.getElementById('no-workflow');

            if (!state?.graph?.nodes?.length) {
                container.innerHTML = '';
                noWorkflow.style.display = 'block';
                return;
            }

            noWorkflow.style.display = 'none';
            const diagram = buildMermaidDiagram(state.graph);
            if (!diagram) return;

            try {
                const { svg } = await mermaid.render('graph-' + Date.now(), diagram);
                container.innerHTML = svg;
                if (!panzoomInstance) initPanzoom();
            } catch (err) {
                console.error('Mermaid error:', err);
                container.innerHTML = '<div style="color: var(--accent-rose); padding: 20px;">Graph render error</div>';
            }
        }

        // Render Functions
        function renderEventBadge(ev) {
            const badge = document.getElementById('event-badge');
            if (!ev) {
                badge.classList.remove('visible');
                return;
            }
            badge.classList.add('visible');
            document.getElementById('event-badge-type').textContent = ev.eventType || '-';
            document.getElementById('event-badge-source').textContent = ev.source || '-';
        }

        function renderTimeline(timeline, replans) {
            const container = document.getElementById('timeline-scroll');

            if ((!timeline || timeline.length === 0) && (!replans || replans.length === 0)) {
                container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">◌</div><div>No activity</div></div>';
                return;
            }

            let html = '';

            if (timeline?.length > 0) {
                html += '<div class="timeline-section"><div class="timeline-section-label">Node Executions</div>';
                timeline.forEach(node => {
                    const status = (node.status || 'PENDING').toLowerCase();
                    html += `
                        <div class="timeline-item ${status}" onclick="openNodeModal('${node.nodeId}')">
                            <div class="timeline-item-header">
                                <span class="timeline-item-name">${escapeHtml(node.nodeId)}</span>
                                <span class="timeline-item-badge">${node.agentType || '-'}</span>
                            </div>
                            <div class="timeline-item-meta">
                                <span>${formatTime(node.startedAt)}</span>
                                <span>${formatDuration(node.durationMs)}</span>
                            </div>
                            ${node.escalationReason ? `<div class="timeline-item-escalation">${escapeHtml(truncate(node.escalationReason, 80))}</div>` : ''}
                        </div>
                    `;
                });
                html += '</div>';
            }

            if (replans?.length > 0) {
                html += '<div class="timeline-section"><div class="timeline-section-label">Replan Events</div>';
                replans.forEach((r, i) => {
                    html += `
                        <div class="replan-item" onclick="openReplanModal(${i})">
                            <div class="replan-item-header">
                                <span class="replan-badge">REPLAN #${r.replanNumber}</span>
                                <span class="replan-action">${r.action || '-'}</span>
                            </div>
                            <div class="replan-trigger">Trigger: ${escapeHtml(r.triggerNodeId || '-')}</div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            container.innerHTML = html;
        }

        function renderExecInfo(state) {
            const info = document.getElementById('exec-info');
            if (!state?.currentExecution) {
                info.classList.remove('visible');
                return;
            }
            info.classList.add('visible');
            const e = state.currentExecution;
            document.getElementById('exec-event-id').textContent = truncate(e.eventId, 20) || '-';
            document.getElementById('exec-workflow').textContent = e.workflowName || '-';
            const statusEl = document.getElementById('exec-status');
            statusEl.textContent = e.state || '-';
            statusEl.className = `exec-value ${(e.state || '').toLowerCase()}`;
            document.getElementById('exec-duration').textContent = formatDuration(e.durationMs);
            document.getElementById('exec-replans').textContent = e.replanCount || 0;
        }

        function renderHistory(history) {
            const container = document.getElementById('history-scroll');
            if (!history?.length) {
                container.innerHTML = '<span style="font-size: 10px; color: var(--text-dim);">No history</span>';
                return;
            }
            container.innerHTML = history.slice(0, 8).map(h => `
                <div class="history-chip${h.eventId === selectedEventId ? ' selected' : ''}" onclick="loadExecution('${h.eventId}')">
                    <span class="history-chip-dot ${h.state || 'UNKNOWN'}"></span>
                    <span>${escapeHtml(truncate(h.workflowName || 'Unknown', 16))}</span>
                </div>
            `).join('');
        }

        function updateStatus(state) {
            const dot = document.getElementById('status-dot');
            const label = document.getElementById('status-label');
            dot.classList.remove('ready', 'active');

            if (!state) {
                label.textContent = 'Offline';
                return;
            }

            if (state.hasActiveExecution) {
                dot.classList.add('active');
                label.textContent = 'Processing';
            } else {
                dot.classList.add('ready');
                label.textContent = 'Ready';
            }
        }

        // Fetch & Poll
        async function fetchState() {
            try {
                const url = selectedEventId ? `/api/v1/debug/${selectedEventId}` : '/api/v1/debug/state';
                const res = await fetch(url);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                currentState = await res.json();

                updateStatus(currentState);
                renderGraph(currentState);
                renderEventBadge(currentState.triggerEvent);
                renderTimeline(currentState.timeline, currentState.replans);
                renderExecInfo(currentState);
                if (!selectedEventId) renderHistory(currentState.recentHistory);

                document.getElementById('back-btn').style.display = selectedEventId ? 'inline' : 'none';
            } catch (err) {
                console.error('Fetch error:', err);
                updateStatus(null);
            }
        }

        async function loadExecution(eventId) {
            selectedEventId = eventId;
            await fetchState();
        }

        function clearSelection() {
            selectedEventId = null;
            fetchState();
        }

        // Init
        let pollInterval = null;
        function startPolling() {
            fetchState();
            pollInterval = setInterval(fetchState, 2000);
        }

        document.addEventListener('DOMContentLoaded', startPolling);
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && pollInterval) {
                clearInterval(pollInterval);
                pollInterval = null;
            } else if (!document.hidden && !pollInterval) {
                startPolling();
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') {
                closeModalById('event-modal');
                closeModalById('node-modal');
                closeModalById('replan-modal');
            }
        });
    </script>
</body>
</html>
